---
title: "Differential gene expression analysis P. feriarum (candidate genes)"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries.
```{r include=F}
library('tidyverse')
library('edgeR')
library('readr')
library('dplyr')
library('reshape')
library('ggplot2')
library('statmod')
library('RColorBrewer')
library('pvclust')
library('dendextend')
#library('ComplexHeatmap')
```

Raw counts file must be a comma delimited file with columns as samples, and rows 
as genes. The metadata file must be a comma delimited file with sample names in 
first column (matching raw counts file), situation (Sym/Allo) in second column, 
and sex in third column. Other columns can be added after.
Specify names of count file and metadata file.
```{r}
countfile <- "./inputs/sumRawCounts.csv"
samplesfile <- "./inputs/samples.csv"
```

Read raw count and metadata file. Remove rows with NAs.
```{r message=F}
df_counts <- read_delim(countfile, delim=",")
df_counts <- na.omit(df_counts)

sampleMeta <- read_delim(samplesfile, delim=",")
```

Remove specific columns/samples (such as outliers).
```{r}
sample_rm <- c("I29365")
df_counts <- df_counts[, -(match(sample_rm, colnames(df_counts)))]
sampleMeta <- sampleMeta[-(match(sample_rm, sampleMeta[[1]])), ]
```

Make vector with group factors to input into DGEList.
```{r}
sample_ids <- apply(sampleMeta[,1:3], 1, paste, collapse="_")
indivs <- sampleMeta[[1]]
situation <- sampleMeta[[2]]
sex <- sampleMeta[[3]]
groups <- factor(paste(situation, sex, sep="."))
```

Create DGEList object from counts table and group factors.
Also, create matrices with CPM and log-CPM counts.
```{r}
# First turn count table into a regular data frame to include in DGEList.
# Use gene names as row names.
df_counts2 <- as.data.frame(df_counts)
rownames(df_counts2) <- df_counts2[[1]]
df_counts2 <- df_counts2[, -1]

# Create DGEList.
dgList <- DGEList(counts=df_counts2, group=groups, genes=rownames(df_counts2))

# Get transfromed counts.
dgList_CPM <- cpm(dgList)
dgList_logCPM <- cpm(dgList, log=T, prior.count=2)
```

Add group factor to sampla metadata.
NOTE: Used for heatmaps annotations.
```{r}
# Add "Group" (situation x sex) column to sampleMeta
sampleMeta <- bind_cols(sampleMeta, group=groups)
```

Plot of count density (log-base2 of counts with 2 pseudocounts), before TMM 
normalization.
```{r}
# Create color categories.
color_table <- cbind(group=levels(groups), 
                     color=c("blue", "deepskyblue", "red", "pink"))

# Add color column to meta data.
sampleMeta <- merge(sampleMeta, color_table, by='group', sort=F)

# Get log-CPM in long format.
dgList_logCPM_long <- melt(dgList_logCPM)
names(dgList_logCPM_long) <- c('RefTrans', 'indiv', 'logCPM')

# Plot count densities.
pdf(file="./density_log2CPM.pdf")
ggplot(dgList_logCPM_long, aes(x=logCPM, color=indiv)) +
  geom_density() +
  scale_color_manual(values=sampleMeta$color) +
  theme_classic()
dev.off()
```

Generate mean-difference (MD) plots. This visualizes the library size-adjusted 
log-foldchange between two libraries (the difference) against the average 
log-expression across those libraries (the mean). The following MD plot is 
generated by comparing sample 1 against an artificial library constructed from 
the average of all other samples. Ideally, the bulk of genes should be centered at 
a log-fold change of zero. This indicates that any composition bias between 
libraries has been successfully removed. This quality check should be repeated by 
constructing a MD plot for each sample.
```{r}
tiff(file="./per_lib_meanDiff_plots.tif", width=1500, height=1500, 
     units='px', res=150)
par(mfrow=c(n2mfrow(length(colnames(dgList)))))
for (i in c(1:length(colnames(dgList)))) {
	plotMD(cpm(dgList, log=T, prior.count=2), column=i) 
	abline(h=0, col="red", lty=2, lwd=2)
}
dev.off()
```

Removal of zero (CPM) count samples and TMM normalization.
Filter genes with mean raw counts < 1, following Li et al (2017), 
(10.1371/journal.pone.0176185). 
```{r}
# The filter was made on non-log CPM counts
keep <- rowMeans(cpm(dgList, log=F, prior.count=2)) >= 1 

# Create filterd DGEList.
dgList_NormTMM <- DGEList(
  dgList$counts[keep, ], group=groups, lib.size= colSums(dgList$counts[keep, ]),
  genes=dgList$genes[keep, ])

# Calculate Trimmed Mean M-values (TMM) normalization factors.
dgList_NormTMM <- calcNormFactors(dgList_NormTMM, method="TMM")
```

Plot log2 count density after normalization methods and removal of zero-count 
samples.
```{r}
# Get log-CPM in long format.
dgList_NormTMM_long <- melt(cpm(dgList_NormTMM$counts, log=T, prior.count=2))
names(dgList_NormTMM_long) <- c('RefTrans', 'indiv', 'TMMlogCPM')

# Plot count densities.
pdf(file="./density_log2CPM_NormTMM.pdf")
ggplot(dgList_NormTMM_long, aes(x=TMMlogCPM, color=indiv)) +
  geom_density() +
  scale_color_manual(values=sampleMeta$color) +
  theme_classic()
dev.off()
```

Mean-difference (MD) plots after normalization
```{r}
tiff(file="./per_lib_meanDiff_NormTMM_plots.tif", width=1500, height=1500, 
     units='px', res=150)
par(mfrow=c(n2mfrow(length(colnames(dgList_NormTMM)))))
for (i in c(1:length(colnames(dgList_NormTMM)))) {
	plotMD(cpm(dgList_NormTMM, log=T, prior.count=2), column=i)
	abline(h=0, col="red", lty=2, lwd=2)
}
dev.off()
```

Generate multi-dimensional scaling plot.
```{r}
pdf(file="./MDS_expr_profiles.pdf")
points <- c(15,15,15,15)
colors <- color_table[, 2]
ordin_plot <- plotMDS(dgList_NormTMM, plot=F)
plot(ordin_plot, col=colors[groups], pch=points[groups], 
     xlab="Leading logFC dim 1", ylab="Leading logFC dim 2", 
     main="Multi-Dim plot TMM-Norm expression profiles")
text(ordin_plot$cmdscale.out, labels=colnames(dgList_NormTMM), 
     col=colors[groups], pos=1)
legend("topright", legend=levels(groups), pch=points, col=colors, ncol=2)
dev.off()
```

Create model matrices to test for DEGs.
```{r}
designGroup <- model.matrix(~ 0 + groups)
colnames(designGroup) <- levels(as.factor(paste0("Group", groups)))

designSex <- model.matrix(~ 0 + sex)
colnames(designSex) <- levels(as.factor(paste0("sex", sex)))

designSituation <- model.matrix(~ 0 + situation)
colnames(designSituation) <- levels(as.factor(paste0("situation", situation)))

designAdditive <- model.matrix(~ 0 + situation + sex)

designFull <- model.matrix(~ 0 + situation + sex + situation:sex)
```

Estimate gene-wise dispersion (Biological coefficent of variation). Generate plot
of biological coefficient of variation (BCV).
```{r}
# Gene dispersion due to situation/sex combination.
dgList_NormDispers_Group <- estimateDisp(
  dgList_NormTMM, designGroup, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./BCV_disperssion_genewise_Group.pdf")
plotBCV(dgList_NormDispers_Group, 
        main="Biological Coefficient of Variation - Group", 
        col.common="gray50", col.trend="gray")
dev.off()

# Gene dispersion due to sex.
dgList_NormDispers_Situation <- estimateDisp(
  dgList_NormTMM, designSituation, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./BCV_disperssion_genewise_Situation.pdf")
plotBCV(dgList_NormDispers_Situation, 
        main="Biological Coefficient of Variation - Situation", 
        col.common="gray50", col.trend="gray")
dev.off()

# Gene dispersion due to situation.
dgList_NormDispers_Sex <- estimateDisp(
  dgList_NormTMM, designSex, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./BCV_disperssion_genewise_Sex.pdf")
plotBCV(dgList_NormDispers_Sex, 
        main="Biological Coefficient of Variation - Sex", 
        col.common="gray50", col.trend="gray")
dev.off()

# Gene dispersion full model.
dgList_NormDispers_Full <- estimateDisp(
  dgList_NormTMM, designFull, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./BCV_disperssion_genewise_Full.pdf")
plotBCV(dgList_NormDispers_Full, 
        main="Biological Coefficient of Variation - FullModel", 
        col.common="gray50", col.trend="gray")
dev.off()
```

Subset data to genes with known involvement in pulse number.
```{r}
pn_genes <- readxl::read_excel("./inputs/CandidateTranscriptsFinal.xlsx")
pn_genes <- unlist(pn_genes)

pn_genes_idx <- match(pn_genes, rownames(dgList_NormDispers_Group$counts))
pn_genes_idx <- na.omit(pn_genes_idx)

dgList_NormDispers_Group_PN <- dgList_NormDispers_Group[pn_genes_idx, ]

dgList_NormDispers_Situation_PN <- dgList_NormDispers_Situation[pn_genes_idx, ]

dgList_NormDispers_Sex_PN <- dgList_NormDispers_Sex[pn_genes_idx, ]

dgList_NormDispers_Full_PN <- dgList_NormDispers_Full[pn_genes_idx, ]
```

Fit negative binomial Generalized linear model.
```{r}
fit_Group <- glmFit(dgList_NormDispers_Group_PN, designGroup)
fit_Sex <- glmFit(dgList_NormDispers_Sex_PN, designSex)
fit_Situation <- glmFit(dgList_NormDispers_Situation_PN, designSituation)
fit_Full <- glmFit(dgList_NormDispers_Full_PN, designFull)
```

Generate contrasts matrices and perform LRTs.
```{r}
# Contrast F vs M
FVsM.contrasts <- makeContrasts(
	FvsM = sexF - sexM, 
	levels=designSex)
lrt_FVsM.contrasts <- glmLRT(fit_Sex, contrast=FVsM.contrasts)
topTags_FVsM.contrasts <- topTags(lrt_FVsM.contrasts, n=1000, 
                                  p.value=0.2, sort.by="PValue")
LRTvalues_FVsM.contrasts <- cbind(lrt_FVsM.contrasts$genes, 
                                  lrt_FVsM.contrasts$table)
write.table(topTags_FVsM.contrasts, "./topTags_FVsM.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_FVsM.contrasts, "./LRT_FVsM.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./FVsM_contrasts_MeanDiff.pdf")
plotMD(lrt_FVsM.contrasts, main="LRT F vs. M")
dev.off()

# Contrast Sym vs Allo
AlloVsSym.contrasts <- makeContrasts(
	AllovsSym = situationAllo - situationSym, 
	levels=designSituation)
lrt_AlloVsSym.contrasts <- glmLRT(fit_Situation, contrast=AlloVsSym.contrasts)
topTags_AlloVsSym.contrasts <- topTags(lrt_AlloVsSym.contrasts, n=1000, 
                                       p.value=0.2, sort.by="PValue")
LRTvalues_AlloVsSym.contrasts <- cbind(lrt_AlloVsSym.contrasts$genes,
                                       lrt_AlloVsSym.contrasts$table)
write.table(topTags_AlloVsSym.contrasts, "./topTags_AlloVsSym.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_AlloVsSym.contrasts, "./LRT_AlloVsSym.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./AlloVsSym_contrasts_MeanDiff.pdf")
plotMD(lrt_AlloVsSym.contrasts, main="LRT Sym vs. Allo", ylim=c(-4,4))
dev.off()

# Contrast Sym vs Allo within MALES
MALES_SymVsAllo.contrasts <- makeContrasts(
	AllovsSym.M = GroupAllo.M - GroupSym.M, 
	levels=designGroup)
lrt_MALES_SymVsAllo.contrasts <- glmLRT(fit_Group, contrast=MALES_SymVsAllo.contrasts)
topTags_MALES_SymVsAllo.contrasts <- topTags(lrt_MALES_SymVsAllo.contrasts, n=1000, 
                                             p.value=0.2, sort.by="PValue")
LRTvalues_MALES_SymVsAllo.contrasts <- cbind(lrt_MALES_SymVsAllo.contrasts$genes,
                                             lrt_MALES_SymVsAllo.contrasts$table)
write.table(topTags_MALES_SymVsAllo.contrasts, "./topTags_MALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_MALES_SymVsAllo.contrasts, "./LRT_MALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./MALES_SymVsAllo_contrasts_MeanDiff.pdf")
plotMD(lrt_MALES_SymVsAllo.contrasts, main="LRT MALES: Sym vs. Allo", ylim=c(-4,4))
dev.off()

# Contrast Sym vs Allo within FEMALES
FEMALES_SymVsAllo.contrasts <- makeContrasts(
	AllovsSym.F = GroupAllo.F - GroupSym.F, 
levels=designGroup)
lrt_FEMALES_SymVsAllo.contrasts <- glmLRT(fit_Group, contrast=FEMALES_SymVsAllo.contrasts)
topTags_FEMALES_SymVsAllo.contrasts <- topTags(lrt_FEMALES_SymVsAllo.contrasts, n=1000, 
                                               p.value=0.2, sort.by="PValue")
LRTvalues_FEMALES_SymVsAllo.contrasts <- cbind(lrt_FEMALES_SymVsAllo.contrasts$genes,
                                               lrt_FEMALES_SymVsAllo.contrasts$table)
write.table(topTags_FEMALES_SymVsAllo.contrasts, "./topTags_FEMALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_FEMALES_SymVsAllo.contrasts, "./LRT_FEMALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./FEMALES_SymVsAllo_contrasts_MeanDiff.pdf")
plotMD(lrt_FEMALES_SymVsAllo.contrasts, main="LRT FEMALES: Sym vs. Allo", ylim=c(-4,4))
dev.off()
```
