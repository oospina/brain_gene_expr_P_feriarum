---
title: "Differential gene expression analysis P. feriarum (new script, same counts)"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries.
```{r include=F}
library('tidyverse')
library('edgeR')
library('RColorBrewer')
library('pvclust')
library('dendextend')
library('ComplexHeatmap')
library('reshape')
```

Raw counts file must be a comma delimited file with columns as samples, and rows 
as genes. The metadata file must be a comma delimited file with sample names in 
first column (matching raw counts file), situation (Sym/Allo) in second column, 
and sex in third column. Other columns can be added after.
Specify names of count file and metadata file.
```{r}
countfile <- "./inputs/sumRawCounts.csv"
samplesfile <- "./inputs/samples.csv"
```

Read raw count and metadata file. Remove rows with NAs.
```{r message=F}
df_counts <- read_delim(countfile, delim=",")
df_counts <- na.omit(df_counts)

sampleMeta <- read_delim(samplesfile, delim=",")
```

Remove specific columns/samples (such as outliers).
```{r}
sample_rm <- c("I29365")
df_counts <- df_counts[, -(match(sample_rm, colnames(df_counts)))]
sampleMeta <- sampleMeta[-(match(sample_rm, sampleMeta[[1]])), ]
```

Make vector with group factors to input into DGEList.
```{r}
sample_ids <- apply(sampleMeta[,1:3], 1, paste, collapse="_")
indivs <- sampleMeta[[1]]
situation <- sampleMeta[[2]]
sex <- sampleMeta[[3]]

groups <- factor(paste(situation, sex, sep="."))
```

Create DGEList object from counts table and group factors.
Also, create matrices with CPM and log-CPM counts.
```{r}
# First turn count table into a regular data frame to include in DGEList.
# Use gene names as row names.
df_counts2 <- as.data.frame(df_counts)
rownames(df_counts2) <- df_counts2[[1]]
df_counts2 <- df_counts2[, -1]

# Create DGEList.
dgList <- DGEList(counts=df_counts2, group=groups, genes=rownames(df_counts2))

# Get transfromed counts.
dgList_CPM <- cpm(dgList)
dgList_logCPM <- cpm(dgList, log=T, prior.count=2)
```

Add group factor to sampla metadata.
NOTE: Used for heatmaps annotations.
```{r}
# Add "Group" (situation x sex) column to sampleMeta
sampleMeta <- bind_cols(sampleMeta, group=groups)
```

Plot of count density (log-base2 of counts with 2 pseudocounts), before TMM 
normalization.
```{r}
# Create color categories.
color_table <- cbind(group=levels(groups), 
                     color=c("blue", "deepskyblue", "red", "pink"))

# Add color column to meta data.
sampleMeta <- merge(sampleMeta, color_table, by='group', sort=F)

# Get log-CPM in long format.
dgList_logCPM_long <- melt(dgList_logCPM)
names(dgList_logCPM_long) <- c('RefTrans', 'indiv', 'logCPM')

# Plot count densities.
pdf(file="./outputs/density_log2CPM.pdf")
ggplot(dgList_logCPM_long, aes(x=logCPM, color=indiv)) +
  geom_density() +
  scale_color_manual(values=sampleMeta$color) +
  theme_classic()
dev.off()
```

Generate mean-difference (MD) plots. This visualizes the library size-adjusted 
log-foldchange between two libraries (the difference) against the average 
log-expression across those libraries (the mean). The following MD plot is 
generated by comparing sample 1 against an artificial library constructed from 
the average of all other samples. Ideally, the bulk of genes should be centered at 
a log-fold change of zero. This indicates that any composition bias between 
libraries has been successfully removed. This quality check should be repeated by 
constructing a MD plot for each sample.
```{r}
tiff(file="./outputs/per_lib_meanDiff_plots.tif", width=1500, height=1500, 
     units='px', res=150)
par(mfrow=c(n2mfrow(length(colnames(dgList)))))
for (i in c(1:length(colnames(dgList)))) {
	plotMD(cpm(dgList, log=T, prior.count=2), column=i) 
	abline(h=0, col="red", lty=2, lwd=2)
}
dev.off()
```

Removal of zero (CPM) count samples and TMM normalization.
Filter genes with mean raw counts < 1, following Li et al (2017), 
(10.1371/journal.pone.0176185). 
```{r}
# The filter was made on non-log CPM counts
keep <- rowMeans(cpm(dgList, log=F, prior.count=2)) >= 1 

# Create filterd DGEList.
dgList_NormTMM <- DGEList(
  dgList$counts[keep, ], group=groups, lib.size= colSums(dgList$counts[keep, ]),
  genes=dgList$genes[keep, ])

# Calculate Trimmed Mean M-values (TMM) normalization factors.
dgList_NormTMM <- calcNormFactors(dgList_NormTMM, method="TMM")
```

Plot log2 count density after normalization methods and removal of zero-count 
samples.
```{r}
# Get log-CPM in long format.
dgList_NormTMM_long <- melt(cpm(dgList_NormTMM$counts, log=T, prior.count=2))
names(dgList_NormTMM_long) <- c('RefTrans', 'indiv', 'TMMlogCPM')

# Plot count densities.
pdf(file="./outputs/density_log2CPM_NormTMM.pdf")
ggplot(dgList_NormTMM_long, aes(x=TMMlogCPM, color=indiv)) +
  geom_density() +
  scale_color_manual(values=sampleMeta$color) +
  theme_classic()
dev.off()
```

Mean-difference (MD) plots after normalization
```{r}
tiff(file="./outputs/per_lib_meanDiff_NormTMM_plots.tif", width=1500, height=1500, 
     units='px', res=150)
par(mfrow=c(n2mfrow(length(colnames(dgList_NormTMM)))))
for (i in c(1:length(colnames(dgList_NormTMM)))) {
	plotMD(cpm(dgList_NormTMM, log=T, prior.count=2), column=i)
	abline(h=0, col="red", lty=2, lwd=2)
}
dev.off()
```

Generate multi-dimensional scaling plot.
```{r}
pdf(file="./outputs/MDS_expr_profiles.pdf")
points <- c(15,15,15,15)
colors <- color_table[, 2]
ordin_plot <- plotMDS(dgList_NormTMM, plot=F)
plot(ordin_plot, col=colors[groups], pch=points[groups], 
     xlab="Leading logFC dim 1", ylab="Leading logFC dim 2", 
     main="Multi-Dim plot TMM-Norm expression profiles")
text(ordin_plot$cmdscale.out, labels=colnames(dgList_NormTMM), 
     col=colors[groups], pos=1)
legend("topright", legend=levels(groups), pch=points, col=colors, ncol=2)
dev.off()
```

Create model matrices to test for DEGs.
```{r}
designGroup <- model.matrix(~ 0 + groups)
colnames(designGroup) <- levels(as.factor(paste0("Group", groups)))

designSex <- model.matrix(~ 0 + sex)
colnames(designSex) <- levels(as.factor(paste0("sex", sex)))

designSituation <- model.matrix(~ 0 + situation)
colnames(designSituation) <- levels(as.factor(paste0("situation", situation)))
```

Estimate gene-wise dispersion (Biological coefficent of variation). Generate plot
of biological coefficient of variation (BCV).
```{r}
# Gene dispersion due to situation/sex combination.
dgList_NormDispers_Group <- estimateDisp(
  dgList_NormTMM, designGroup, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./outputs/BCV_disperssion_genewise_Group.pdf")
plotBCV(dgList_NormDispers_Group, 
        main="Biological Coefficient of Variation - Group", 
        col.common="gray50", col.trend="gray")
dev.off()

# Gene dispersion due to sex.
dgList_NormDispers_Situation <- estimateDisp(
  dgList_NormTMM, designSituation, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./outputs/BCV_disperssion_genewise_Situation.pdf")
plotBCV(dgList_NormDispers_Situation, 
        main="Biological Coefficient of Variation - Situation", 
        col.common="gray50", col.trend="gray")
dev.off()

# Gene dispersion due to situation.
dgList_NormDispers_Sex <- estimateDisp(
  dgList_NormTMM, designSex, mixed.df=F, robust=T)

# Plot dispersion (Biological coefficient of variation)
pdf(file="./outputs/BCV_disperssion_genewise_Sex.pdf")
plotBCV(dgList_NormDispers_Sex, 
        main="Biological Coefficient of Variation - Sex", 
        col.common="gray50", col.trend="gray")
dev.off()
```

Fit negative binomial Generalized linear model.
```{r}
fit_Group <- glmFit(dgList_NormDispers_Group, designGroup)
fit_Sex <- glmFit(dgList_NormDispers_Sex, designSex)
fit_Situation <- glmFit(dgList_NormDispers_Situation, designSituation)
```

Generate contrasts matrices and perform LRTs.
```{r}
# Contrast F vs M
FVsM.contrasts <- makeContrasts(
	FvsM = sexF - sexM, 
	levels=designSex)
lrt_FVsM.contrasts <- glmLRT(fit_Sex, contrast=FVsM.contrasts)
topTags_FVsM.contrasts <- topTags(lrt_FVsM.contrasts, n=1000, 
                                  p.value=0.05, sort.by="PValue")
LRTvalues_FVsM.contrasts <- cbind(lrt_FVsM.contrasts$genes, 
                                  lrt_FVsM.contrasts$table)
write.table(topTags_FVsM.contrasts, "./outputs/topTags_FVsM.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_FVsM.contrasts, "./outputs/LRT_FVsM.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./outputs/FVsM_contrasts_MeanDiff.pdf")
plotMD(lrt_FVsM.contrasts, main="LRT F vs. M")
dev.off()

# Contrast Sym vs Allo
AlloVsSym.contrasts <- makeContrasts(
	AllovsSym = situationAllo - situationSym, 
	levels=designSituation)
lrt_AlloVsSym.contrasts <- glmLRT(fit_Situation, contrast=AlloVsSym.contrasts)
topTags_AlloVsSym.contrasts <- topTags(lrt_AlloVsSym.contrasts, n=1000, 
                                       p.value=0.05, sort.by="PValue")
LRTvalues_AlloVsSym.contrasts <- cbind(lrt_AlloVsSym.contrasts$genes,
                                       lrt_AlloVsSym.contrasts$table)
write.table(topTags_AlloVsSym.contrasts, "./outputs/topTags_AlloVsSym.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_AlloVsSym.contrasts, "./outputs/LRT_AlloVsSym.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./outputs/AlloVsSym_contrasts_MeanDiff.pdf")
plotMD(lrt_AlloVsSym.contrasts, main="LRT Sym vs. Allo")
dev.off()

# Contrast Sym vs Allo within MALES
MALES_SymVsAllo.contrasts <- makeContrasts(
	AllovsSym.M = GroupAllo.M - GroupSym.M, 
	levels=designGroup)
lrt_MALES_SymVsAllo.contrasts <- glmLRT(fit_Group, contrast=MALES_SymVsAllo.contrasts)
topTags_MALES_SymVsAllo.contrasts <- topTags(lrt_MALES_SymVsAllo.contrasts, n=500, 
                                             p.value=0.05, sort.by="PValue")
LRTvalues_MALES_SymVsAllo.contrasts <- cbind(lrt_MALES_SymVsAllo.contrasts$genes,
                                             lrt_MALES_SymVsAllo.contrasts$table)
write.table(topTags_MALES_SymVsAllo.contrasts, "./outputs/topTags_MALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_MALES_SymVsAllo.contrasts, "./outputs/LRT_MALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./outputs/MALES_SymVsAllo_contrasts_MeanDiff.pdf")
plotMD(lrt_MALES_SymVsAllo.contrasts, main="LRT MALES: Sym vs. Allo")
dev.off()

# Contrast Sym vs Allo within FEMALES
FEMALES_SymVsAllo.contrasts <- makeContrasts(
	AllovsSym.F = GroupAllo.F - GroupSym.F, 
levels=designGroup)
lrt_FEMALES_SymVsAllo.contrasts <- glmLRT(fit_Group, contrast=FEMALES_SymVsAllo.contrasts)
topTags_FEMALES_SymVsAllo.contrasts <- topTags(lrt_FEMALES_SymVsAllo.contrasts, n=500, 
                                               p.value=0.05, sort.by="PValue")
LRTvalues_FEMALES_SymVsAllo.contrasts <- cbind(lrt_FEMALES_SymVsAllo.contrasts$genes,
                                               lrt_FEMALES_SymVsAllo.contrasts$table)
write.table(topTags_FEMALES_SymVsAllo.contrasts, "./outputs/topTags_FEMALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_FEMALES_SymVsAllo.contrasts, "./outputs/LRT_FEMALES_SymVsAllo.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./outputs/FEMALES_SymVsAllo_contrasts_MeanDiff.pdf")
plotMD(lrt_FEMALES_SymVsAllo.contrasts, main="LRT FEMALES: Sym vs. Allo")
dev.off()

# Contrast F vs M within SYMPATRY
SYMPATRY_FVsM.contrasts <- makeContrasts(
	Sym.FvsM = GroupSym.F - GroupSym.M, 
	levels=designGroup)
lrt_SYMPATRY_FVsM.contrasts <- glmLRT(fit_Group, contrast=SYMPATRY_FVsM.contrasts)
topTags_SYMPATRY_FVsM.contrasts <- topTags(lrt_SYMPATRY_FVsM.contrasts, n=500, 
                                           p.value=0.05, sort.by="PValue")
LRTvalues_SYMPATRY_FVsM.contrasts  <- cbind(lrt_SYMPATRY_FVsM.contrasts$genes,
                                            lrt_SYMPATRY_FVsM.contrasts$table)
write.table(topTags_SYMPATRY_FVsM.contrasts, "./outputs/topTags_SYMPATRY_FVsM.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_SYMPATRY_FVsM.contrasts, "./outputs/LRT_SYMPATRY_FVsM.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./outputs/SYMPATRY_FVsM_contrasts_MeanDiff.pdf")
plotMD(lrt_SYMPATRY_FVsM.contrasts, main="LRT SYMPATRY: F vs. M")
dev.off()

# Contrast F vs M within ALLOPATRY
ALLOPATRY_FVsM.contrasts <- makeContrasts(
	Allo.FvsM = GroupAllo.F - GroupAllo.M, 
levels=designGroup)
lrt_ALLOPATRY_FVsM.contrasts <- glmLRT(fit_Group, contrast=ALLOPATRY_FVsM.contrasts)
topTags_ALLOPATRY_FVsM.contrasts <- topTags(lrt_ALLOPATRY_FVsM.contrasts, n=500, 
                                            p.value=0.05, sort.by="PValue")
LRTvalues_ALLOPATRY_FVsM.contrasts <- cbind(lrt_ALLOPATRY_FVsM.contrasts$genes,
                                            lrt_ALLOPATRY_FVsM.contrasts$table)
write.table(topTags_ALLOPATRY_FVsM.contrasts, "./outputs/topTags_ALLOPATRY_FVsM.txt", 
            sep="\t", quote=F, row.names=F)
write.table(LRTvalues_ALLOPATRY_FVsM.contrasts, "./outputs/LRT_ALLOPATRY_FVsM.txt", 
            sep="\t", quote=F, row.names=F)

pdf(file="./outputs/ALLOPATRY_FVsM_contrasts_MeanDiff.pdf")
plotMD(lrt_ALLOPATRY_FVsM.contrasts, main="LRT ALLOPATRY: F vs. M")
dev.off()
```

P-value histograms.
```{r}
pdf(file="./outputs/p_value_histograms.pdf")

lrts <- ls() %>% grep("lrt_", ., value=T)

for(lrt in lrts){
  
  lrttitle <- lrt %>% gsub("lrt_", "", .)  %>% gsub(".contrasts", "", .)
  
  p <- ggplot(get(lrt)$table, aes(x=PValue)) +
    geom_histogram(fill="gray", color="black") +
    ylab("Frequency") +
    xlab("Nominal p-value (before FDR)") +
    ggtitle(lrttitle) +
    theme_classic()

  print(p)
  
}

dev.off()
```

Generate heatmaps of DE genes
```{r include=F}
source("../scripts-workflows/heatmap_mtx.R")

mypalette <- brewer.pal(11,"PRGn")
morecols <- colorRampPalette(mypalette)


## Heatmap F vs M
z_logcpm_FVsM <- heatmap_mtx(dgList_NormDispers_Sex,
                             topTags_FVsM.contrasts)

ColType <- sampleMeta$group[match(sampleMeta$library, colnames(z_logcpm_FVsM))]

pdf(file="./outputs/FVsM_PVClust.pdf")
# genesPV <- pvclust(t(z_logcpm_SymVsAllo), nboot=100)
feriarumPV_FVsM <- pvclust(z_logcpm_FVsM, nboot=100)
feriarumPV_FVsM$hclust <- rotate(feriarumPV_FVsM$hclust, 
c("I29359", "I29361", "I29363", "I29367", "I29369", "I29370", "I29373", "I29357", 
  "I29358", "I29360", "I29362", "I29364", "I29366", "I29368", "I29371", "I29372"))
plot(feriarumPV_FVsM)
dev.off()
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, col = list(
  type = c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
pdf(file="./outputs/FVsM_heatmap.pdf", height=15, width=10)
Heatmap(z_logcpm_FVsM, cluster_columns = feriarumPV_FVsM$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()


## Heatmap Sym vs Allo
z_logcpm_SymVsAllo <- heatmap_mtx(dgList_NormDispers_Situation,
                             topTags_AlloVsSym.contrasts)

ColType <- sampleMeta$group[match(sampleMeta$library, colnames(z_logcpm_SymVsAllo))]

pdf(file="./outputs/SymVsAllo_PVClust.pdf")
# genesPV <- pvclust(t(z_logcpm_SymVsAllo), nboot=100)
feriarumPV_SymVsAllo <- pvclust(z_logcpm_SymVsAllo, nboot=100)
feriarumPV_SymVsAllo$hclust <- rotate(feriarumPV_SymVsAllo$hclust, 
c("I29359", "I29361", "I29363", "I29367", "I29369", "I29370", "I29373", "I29357", 
  "I29358", "I29360", "I29362", "I29364", "I29366", "I29368", "I29371", "I29372"))
plot(feriarumPV_SymVsAllo)
dev.off()
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, col = list(type = c(
  "Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
pdf(file="./outputs/SymVsAllo_heatmap.pdf", height=15, width=10)
Heatmap(z_logcpm_SymVsAllo, cluster_columns = feriarumPV_SymVsAllo$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()


## Heatmap Sym vs Allo within MALES
z_logcpm_MALES_SymVsAllo <- heatmap_mtx(dgList_NormDispers_Group,
                             topTags_MALES_SymVsAllo.contrasts)

ColType <- sampleMeta$group[match(sampleMeta$library, colnames(z_logcpm_MALES_SymVsAllo))]

pdf(file="./outputs/MALES_SymVsAllo_PVClust.pdf")
# genesPV <- pvclust(t(z_logcpm_MALES_SymVsAllo), nboot=100)
feriarumPV_MALES_SymVsAllo <- pvclust(z_logcpm_MALES_SymVsAllo, nboot=100)
feriarumPV_MALES_SymVsAllo$hclust <- rotate(feriarumPV_MALES_SymVsAllo$hclust, 
c("I29359", "I29361", "I29363", "I29367", "I29369", "I29370", "I29373", "I29357", 
  "I29358", "I29360", "I29362", "I29364", "I29366", "I29368", "I29371", "I29372"))
plot(feriarumPV_MALES_SymVsAllo)
dev.off()
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, col = list(type = c(
  "Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
pdf(file="./outputs/MALES_SymVsAllo_heatmap.pdf", height=15, width=10)
Heatmap(z_logcpm_MALES_SymVsAllo, cluster_columns = feriarumPV_MALES_SymVsAllo$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()


## Heatmap Sym vs Allo within FEMALES
z_logcpm_FEMALES_SymVsAllo <- heatmap_mtx(dgList_NormDispers_Group,
                             topTags_FEMALES_SymVsAllo.contrasts)

ColType <- sampleMeta$group[match(sampleMeta$library, colnames(z_logcpm_FEMALES_SymVsAllo))]

pdf(file="./outputs/FEMALES_SymVsAllo_PVClust.pdf")
# genesPV <- pvclust(t(z_logcpm_FEMALES_SymVsAllo), nboot=100)
feriarumPV_FEMALES_SymVsAllo <- pvclust(z_logcpm_FEMALES_SymVsAllo, nboot=100)
feriarumPV_FEMALES_SymVsAllo$hclust <- rotate(feriarumPV_FEMALES_SymVsAllo$hclust, 
c("I29362", "I29359", "I29361", "I29363", "I29367", "I29369", "I29370", "I29373", 
  "I29357", "I29358", "I29360", "I29364", "I29366", "I29368", "I29371", "I29372"))
plot(feriarumPV_FEMALES_SymVsAllo)
dev.off()
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, col = list(type = c(
  "Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
pdf(file="./outputs/FEMALES_SymVsAllo_heatmap.pdf", height=30, width=10)
Heatmap(z_logcpm_FEMALES_SymVsAllo, cluster_columns = feriarumPV_FEMALES_SymVsAllo$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()


## Heatmap F vs M within SYMPATYRY
z_logcpm_SYMPATRY_FVsM <- heatmap_mtx(dgList_NormDispers_Group,
                             topTags_SYMPATRY_FVsM.contrasts)

ColType <- sampleMeta$group[match(sampleMeta$library, colnames(z_logcpm_SYMPATRY_FVsM))]

pdf(file="./outputs/SYMPATRY_FVsM_PVClust.pdf")
# genesPV <- pvclust(t(z_logcpm_SYMPATRY_FVsM), nboot=100)
feriarumPV_SYMPATRY_FVsM <- pvclust(z_logcpm_SYMPATRY_FVsM, nboot=100)
feriarumPV_SYMPATRY_FVsM$hclust <- rotate(feriarumPV_SYMPATRY_FVsM$hclust, 
c("I29359", "I29363", "I29367", "I29369", "I29370", "I29373", "I29361", "I29357", 
  "I29358", "I29360", "I29362", "I29364",  "I29366", "I29368", "I29371", "I29372"))
plot(feriarumPV_SYMPATRY_FVsM)
dev.off()
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, col = list(type = c(
  "Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
pdf(file="./outputs/SYMPATRY_FVsM_heatmap.pdf", height=20, width=10)
Heatmap(z_logcpm_SYMPATRY_FVsM, cluster_columns = feriarumPV_SYMPATRY_FVsM$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette),
# cluster_rows=genesPV$hclust, 
cluster_rows=T, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=T)
dev.off()


## Heatmap F vs M within ALLOPATYRY
z_logcpm_ALLOPATRY_FVsM <- heatmap_mtx(dgList_NormDispers_Group,
                             topTags_ALLOPATRY_FVsM.contrasts)

ColType <- sampleMeta$group[match(sampleMeta$library, colnames(z_logcpm_ALLOPATRY_FVsM))]

pdf(file="./outputs/ALLOPATRY_FVsM_PVClust.pdf")
# genesPV <- pvclust(t(z_logcpm_ALLOPATRY_FVsM), nboot=100)
feriarumPV_ALLOPATRY_FVsM <- pvclust(z_logcpm_ALLOPATRY_FVsM, nboot=100)
feriarumPV_ALLOPATRY_FVsM$hclust <- rotate(feriarumPV_ALLOPATRY_FVsM$hclust, 
c("I29359", "I29361", "I29363", "I29367", "I29369", "I29370", "I29373", "I29366", 
  "I29372", "I29368", "I29371", "I29357", "I29358", "I29360", "I29362", "I29364"))
plot(feriarumPV_ALLOPATRY_FVsM)
dev.off()
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, col = list(type = c(
  "Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
pdf(file="./outputs/ALLOPATRY_FVsM_heatmap.pdf", height=20, width=10)
Heatmap(z_logcpm_ALLOPATRY_FVsM, cluster_columns = feriarumPV_ALLOPATRY_FVsM$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=T, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=T)
dev.off()
```

Generate heatmaps with gene annotations
```{r}
# deGenesfpath <- "~/Desktop/AlanCounts_DEGenes_ALL.txt"
annotsfpath <- "./inputs/sprotAnnots_Trinotate_UniqueGenes_SYMBOLS.txt"
annots <- read.csv(annotsfpath)
# deGenes <- read.csv(deGenesfpath)
# deGenes <- as.vector(deGenes[[1]])

## Heatmap Sym vs Allo w/GENE ANNOTATIONS
annotsHmap <- rownames(z_logcpm_SymVsAllo) %in% annots[[1]] ## Finds TOM genes in the list of DE genes
annotAlt <- c()
for(i in 1:length(annotsHmap)) {
	idTemp <- as.vector(rownames(z_logcpm_SymVsAllo)[i])
	if(annotsHmap[i] == "TRUE") {
		symbolTemp <- annots[grep(idTemp, as.vector(annots[[1]])), 2]
		annotAlt[i] <- as.vector(symbolTemp)
	}
	else {
		annotAlt[i] <- idTemp
	}
}
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F,
                            col=list(type=c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
z_logcpm_SymVsAllo_Annots <- z_logcpm_SymVsAllo
rownames(z_logcpm_SymVsAllo_Annots) <- annotAlt 
pdf(file="./outputs/SymVsAllo_heatmap_wAnnots.pdf", height=80, width=10)
Heatmap(z_logcpm_SymVsAllo_Annots, cluster_columns=feriarumPV_SymVsAllo$hclust, 
        heatmap_legend_param = list(title = "feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()

## Heatmap F vs M w/GENE ANNOTATIONS
annotsHmap <- rownames(z_logcpm_FVsM) %in% annots[[1]] ## Finds TOM genes in the list of DE genes
annotAlt <- c()
for(i in 1:length(annotsHmap)) {
	idTemp <- as.vector(rownames(z_logcpm_FVsM)[i])
	if(annotsHmap[i] == "TRUE") {
		symbolTemp <- annots[grep(idTemp, as.vector(annots[[1]])), 2]
		annotAlt[i] <- as.vector(symbolTemp)
	}
	else {
		annotAlt[i] <- idTemp
	}
}
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, 
                            col=list(type=c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
z_logcpm_FVsM_Annots <- z_logcpm_FVsM
rownames(z_logcpm_FVsM_Annots) <- annotAlt 
pdf(file="./outputs/FVsM_heatmap_wAnnots.pdf", height=30, width=10)
Heatmap(z_logcpm_FVsM_Annots, cluster_columns=feriarumPV_FVsM$hclust, 
        heatmap_legend_param=list(title="feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()

## Heatmap Sym vs Allo within MALES w/GENE ANNOTATIONS
annotsHmap <- rownames(z_logcpm_MALES_SymVsAllo) %in% annots[[1]] ## Finds TOM genes in the list of DE genes
annotAlt <- c()
for(i in 1:length(annotsHmap)) {
	idTemp <- as.vector(rownames(z_logcpm_MALES_SymVsAllo)[i])
	if(annotsHmap[i] == "TRUE") {
		symbolTemp <- annots[grep(idTemp, as.vector(annots[[1]])), 2]
		annotAlt[i] <- as.vector(symbolTemp)
	}
	else {
		annotAlt[i] <- idTemp
	}
}
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, 
                            col = list(type=c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
z_logcpm_MALES_SymVsAllo_Annots <- z_logcpm_MALES_SymVsAllo
rownames(z_logcpm_MALES_SymVsAllo_Annots) <- annotAlt 
pdf(file="./outputs/MALES_SymVsAllo_heatmap_wAnnots.pdf", height=15, width=10)
Heatmap(z_logcpm_MALES_SymVsAllo_Annots, cluster_columns=feriarumPV_MALES_SymVsAllo$hclust, 
        heatmap_legend_param=list(title="feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()

## Heatmap Sym vs Allo within FEMALES w/GENE ANNOTATIONS
annotsHmap <- rownames(z_logcpm_FEMALES_SymVsAllo) %in% annots[[1]] ## Finds TOM genes in the list of DE genes
annotAlt <- c()
for(i in 1:length(annotsHmap)) {
	idTemp <- as.vector(rownames(z_logcpm_FEMALES_SymVsAllo)[i])
	if(annotsHmap[i] == "TRUE") {
		symbolTemp <- annots[grep(idTemp, as.vector(annots[[1]])), 2]
		annotAlt[i] <- as.vector(symbolTemp)
	}
	else {
		annotAlt[i] <- idTemp
	}
}
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, 
                            col=list(type=c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
z_logcpm_FEMALES_SymVsAllo_Annots <- z_logcpm_FEMALES_SymVsAllo
rownames(z_logcpm_FEMALES_SymVsAllo_Annots) <- annotAlt
pdf(file="./outputs/FEMALES_SymVsAllo_heatmap_wAnnots.pdf", height=30, width=10)
Heatmap(z_logcpm_FEMALES_SymVsAllo_Annots, cluster_columns=feriarumPV_FEMALES_SymVsAllo$hclust, 
        heatmap_legend_param=list(title="feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=F, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=F)
dev.off()

## Heatmap F vs M within SYMPATYRY w/GENE ANNOTATIONS
annotsHmap <- rownames(z_logcpm_SYMPATRY_FVsM) %in% annots[[1]] ## Finds TOM genes in the list of DE genes
annotAlt <- c()
for(i in 1:length(annotsHmap)) {
	idTemp <- as.vector(rownames(z_logcpm_SYMPATRY_FVsM)[i])
	if(annotsHmap[i] == "TRUE") {
		symbolTemp <- annots[grep(idTemp, as.vector(annots[[1]])), 2]
		annotAlt[i] <- as.vector(symbolTemp)
	}
	else {
		annotAlt[i] <- idTemp
	}
}
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F,
                            col=list(type=c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
z_logcpm_SYMPATRY_FVsM_Annots <- z_logcpm_SYMPATRY_FVsM
rownames(z_logcpm_SYMPATRY_FVsM_Annots) <- annotAlt
pdf(file="./outputs/SYMPATRY_FVsM_heatmap_wAnnots.pdf", height=20, width=10)
Heatmap(z_logcpm_SYMPATRY_FVsM_Annots, cluster_columns=feriarumPV_SYMPATRY_FVsM$hclust, 
        heatmap_legend_param=list(title="feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette),
# cluster_rows=genesPV$hclust, 
cluster_rows=T, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=T)
dev.off()

## Heatmap F vs M within ALLOPATYRY w/GENE ANNOTATIONS
annotsHmap <- rownames(z_logcpm_ALLOPATRY_FVsM) %in% annots[[1]] ## Finds TOM genes in the list of DE genes
annotAlt <- c()
for(i in 1:length(annotsHmap)) {
	idTemp <- as.vector(rownames(z_logcpm_ALLOPATRY_FVsM)[i])
	if(annotsHmap[i] == "TRUE") {
		symbolTemp <- annots[grep(idTemp, as.vector(annots[[1]])), 2]
		annotAlt[i] <- as.vector(symbolTemp)
	}
	else {
		annotAlt[i] <- idTemp
	}
}
hAnnot <- HeatmapAnnotation(type=ColType, show_legend=F, 
                            col=list(type=c("Allo.F"="blue", "Allo.M"="deepskyblue", "Sym.F"="red", "Sym.M"="pink")))
z_logcpm_ALLOPATRY_FVsM_Annots <- z_logcpm_ALLOPATRY_FVsM
rownames(z_logcpm_ALLOPATRY_FVsM_Annots) <- annotAlt
pdf(file="./outputs/ALLOPATRY_FVsM_heatmap_wAnnots.pdf", height=20, width=10)
Heatmap(z_logcpm_ALLOPATRY_FVsM_Annots, cluster_columns=feriarumPV_ALLOPATRY_FVsM$hclust, 
        heatmap_legend_param=list(title="feriarum"), bottom_annotation=hAnnot, 
col=rev(mypalette), 
# cluster_rows=genesPV$hclust, 
cluster_rows=T, clustering_distance_rows="euclidean",
show_row_dend=F, row_dend_reorder=T)
dev.off()

```

Generate multi-dimensional scaling plot based only on DE genes.
```{r}
tTags_ALLDFs <- grep("topTags", ls(), value=T)

tTagstmp <- get(tTags_ALLDFs[1])$table
for(i in 2:length(tTags_ALLDFs)) {
	tTagstmp <- rbind(tTagstmp, get(tTags_ALLDFs[i])$table)
}

AlltTags <- unique(rownames(tTagstmp))

dgList_NormTMM_AlltTags <- as.data.frame(dgList_NormTMM$counts)[AlltTags, ]
dgList_NormTMM_AlltTags <- na.omit(dgList_NormTMM_AlltTags)

pdf(file="./outputs/MDS_log2expr_profiles_DEGenes.pdf")
points <- c(15,15,15,15)
colors <- c("blue", "deepskyblue", "red", "pink")
ordin_plot <- plotMDS(cpm(dgList_NormTMM_AlltTags, prior.count=2, log=T), plot=F)
plot(ordin_plot, col=colors[groups], pch=points[groups], 
     xlab="Leading logFC dim 1", 
     ylab="Leading logFC dim 2", main="Multi-Dim plot TMM-Norm expression profiles")
text(ordin_plot$cmdscale.out, labels=colnames(dgList_NormTMM), col=colors[groups], pos=1)
legend("topright", legend=levels(groups), pch=points, col=colors, ncol=2)
dev.off()

```
